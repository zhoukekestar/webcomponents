<!-- https://github.com/Polymer/TemplateBinding -->
<!-- https://github.com/Polymer/TemplateBinding/blob/master/src/TemplateBinding.js -->
<style>
  template-mini {
    display: none;
  }
</style>
<script>
  (function(){
    var proto = Object.create(HTMLElement.prototype)
      , directive = [];

    // Modal
    proto.modal = '';

    // Directives: repeat
    directive.push({
      name: 'z-repeat',
      parseChildren: false,
      handler: function(dom, expression, scope) {
        try {
          var parent = dom.parentNode;
          dom.remove();

          // expression
          var expression = expression.split(' in ');
          expression = {
            itemName: expression[0].trim(),
            itemsName: 'scope.' + expression[1].trim()
          }
          expression.items = eval(expression.itemsName);

          // repeat
          for (var item in expression.items) {
            var copyDom = dom.cloneNode(true);
            copyDom.removeAttribute('z-repeat');
            var copyScope = function() {
              this[expression.itemName] = expression.items[item];
              this.index = item;
            }
            copyScope.prototype = scope;
            parent.appendChild(parseDom(copyDom, new copyScope()))
          }

        } catch (e) {
          console.warn('z-repeat ERROR:' + e)
        }

      }
    })

    // Directives: if
    directive.push({
      name: 'z-if',
      handler: function(dom, expression, scope) {
        try {
          if (eval('scope.' + expression)) {
            dom.removeAttribute('z-if');
            return true;
          }
        } catch (e) {
          console.warn('z-if ERROR:' + e + ' on dom:');
          console.warn(dom)
        }
        dom.remove();
        return false;
      }
    })


    /**
     * Parse dom
     *  dom: the dom you want to parse
     *  scope: the data that will be used if some value shold be parsed
     **/
    var parseDom = function(dom, scope) {
      for (var i = 0; i < dom.children.length; i++) {
        var currentElement = dom.children[i];

        // Parse Children flag
        var parseChildren = true;

        // Execute directive
        for (var j = 0; j < directive.length; j++) {
          var expression = currentElement.getAttribute(directive[j].name);
          if (expression) {

            if (directive[j].parseChildren === false)
              parseChildren = false;

            directive[j].handler(currentElement, expression, scope)
          }
        }

        // Element has children. And parse children is true
        if (currentElement.children && parseChildren) {
          parseDom(currentElement, scope);
        }
      }

      dom.innerHTML = dom.innerHTML.replace(/{{(\S*?)}}/g, function() {
        try {
          var name = 'scope_' + Date.now();
          window[name] = scope;
          // var value = eval("'use strict'; (function() {with(scope) { return " + arguments[1] + "}})() ");
          var value = eval('(function(scope) {with(scope) { return ' + arguments[1] + '}})(window["' + name + '"])');
          return value;
        } catch (e) {
          return '';
        }
      })

      return dom;
    }

    /*
     * Save innerHTML to _innerHTML
     */
    proto.createdCallback  = function() {
      this._innerHTML = this.innerHTML;
    }

    proto.attachedCallback = function() {

    }

    /**
     * Set modal and apply it to dom.
     **/
    proto.setModal = function(d) {
      this.modal = d;
      this.style.display = 'none';
      this.innerHTML = this._innerHTML;
      parseDom(this, this.modal);
      this.style.display = 'block';
    }

    document.registerElement('template-mini', {
      prototype: proto
    });
  })();
</script>
